<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticación con JWT Tokens</title>
    <link rel="stylesheet" href="../styles/dev-guias.css" />
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.7/dist/iconify-icon.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>    
    <header id="inicio">
        <div class="titulo-inicio">
            <h2>Guías ASP.NET Core</h2>
            <img  class="logo-main-header" src="../images/ovni-dino.png"/> 
        </div>
        <div class="header-img-container">              
            <img class="logo-tech" src="../images/asp-net-core-logo.png">
            <img class="logo-tech" src="../images/sql-server.png">
            <img class="logo-tech" src="../images/jwt-logo.png">
        </div>
    </header>  
    <nav id="navbar">              
        <header> 
            <div class="nav-header-img">
                <a class="logo-home" href="../index.html"><iconify-icon class="icon-home" icon="eva:home-fill"></iconify-icon><img  class="logo-main" src="../images/dino-face.png"/></a>
            </div>
            <h1>Autenticación con JWT Tokens</h1>               
        </header>
        <ul>
            <li><a class="nav-link" href="#inicio">Proteger una API ASP.NET Core con JWT</a></li>
            <li><a class="nav-link" href="#Requisitos_previos">Requisitos previos</a></li>
            <li><a class="nav-link" href="#Conocimientos_requeridos">Qué necesito saber</a></li>
            <li><a class="nav-link" href="#crear_tablas">Crear las entidades necesarias</a></li>
            <li><a class="nav-link" href="#code_first">Opción Code First</a></li>
            <li><a class="nav-link" href="#instalar_paquetes">Instalar Paquetes</a></li>  
            <li><a class="nav-link" href="#configuracion">Configuracion para usar el paquete JWT Bearer</a></li>  
            <li><a class="nav-link" href="#registrar_usuarios">Registrar usuarios</a></li>   
            <li><a class="nav-link" href="#clase_jwt_admin">Emitir y valdar tokens</a></li>   
            <li><a class="nav-link" href="#probar">Probar el sistema de autenticación</a></li>   
            <li><a class="nav-link" href="#consumir">Consumir una API con autenticación JWT</a></li>   
        </ul>
    </nav>
    <main id="main-doc">        
        <section class="main-section" id="Introduccion">
            <header>Proteger una API ASP.NET Core con JWT</header>
            <article>          
                <p>
                    JWT (JSON Web Token) ofrece un sistema de autenticación para proteger y regular el acceso a los recursos de nuestra API, mediante el uso de tokens de seguridad.                    
                </p>
                <h2>Características del sistema de autenticación con JWT</h2> 
                <ul>
                    <li>Se requiere contar con un sistema de login. Para ello, es necesario crear las tablas correspondientes en nuestra base de datos.</li>
                    <li>Cuando un usuario inicia sesión, si las credenciales son válidas, recibe como resultado un token de acceso.</li>
                    <li>Para acceder a los recursos de la API será requerido incorporar este token en el header de la solicitud, para aquellos recursos que se encuentren protegidos.</li>                    
                </ul>  
                <br> 
                <p>
                    ASP.NET Core, también cuenta con un paquete de administración de usuarios llamado <i>Identity</i>, el cual proporciona varias funcionalidades relacionadas con la autenticación y autorización de usuarios. 
                </p>             
                <p>
                    En esta guía, dado que la intención es centrarnos en el uso de JWT, no usaremos <i>Identity</i> y nos limitaremos a usar una tabla de usuarios sensilla, para entender cómo funciona esta herramienta. Si te interesa investigar lo que ofrece <i>Identity</i>, podés visitar la <a href="https://learn.microsoft.com/es-es/aspnet/core/security/authentication/identity?view=aspnetcore-8.0&tabs=visual-studio">página de documentación oficial de Microsoft</a>.
                </p>
                <p>
                    Si querés saber más sobre JWT, podés visitar el <a href="https://jwt.io/">sitio oficial de JWT</a>, donde encontrarás toda la documentación disponible.
                </p>                
            </article>
        </section>
        <section class="main-section" id="Requisitos_previos">
            <header>Requisitos previos</header>
            <article>
                <p>Para desarrollar lo propuesto en esta guía, es necesario contar con:</p>

                <ul>
                    <li>
                        Visual Studio 2022 configurado para poder crear aplicaciones ASP.NET con C#.
                    </li>
                    <li>
                        SQL Server Management Studio o Azure Data Studio.
                    </li>
                    <li>
                        Un proyecto ASP.NET Core Web API (.NET 6 o superior).
                    </li>
                    <li>
                        Postman (No es obligatorio, pero es recomendable).
                    </li>                    
                </ul>
            </article>
        </section>
        <section class="main-section" id="Conocimientos_requeridos">
            <header>Qué necesito saber</header>
            <article>
                <p>En esta guía se asume que contás con los siguientes conocimientos:</p>
                <ul>
                    <li>
                        ASP.NET Core Web API (.NET 6 o superior).
                    </li> 
                    <li>
                        Entity Framework Core.
                    </li>  
                    <li>
                        Nociones básicas del protocolo HTTP.
                    </li>    
                    <li>
                        Enfoques DB First y Code First (comandos básicos en consola PM).
                    </li>                
                </ul>                                 
                <p>
                    En caso de que necesites repasar algunos conceptos acerca de cómo desarrollar una API con .NET Core, te recomiendo que eches un vistazo a la <a href="./guia-web-api.html">Guía ASP.NET Core Web API</a>, o bien podés visitar la <a href="https://learn.microsoft.com/en-us/aspnet/core/tutorials/first-web-api?view=aspnetcore-8.0&tabs=visual-studio">documentación oficial de Microsoft</a>. 
                </p>
               
            </article>
        </section>
        <section class="main-section" id="crear_tablas">
            <header>Crear las entidades necesarias</header>            
            <article>  
                <div class="notas">
                    NOTAS:
                    <ul>
                        <li>
                            Este paso es válido en caso de estar trabajando en un proyecto BD First.
                        </li>
                        <li>
                            Si se trata de un proyecto Code First, ver el apartado para <a href="#code_first"> Opción Code First</a>.
                        </li>
                    </ul>                
                </div>                          
                <p>
                    Se crea la tabla <b>Users</b> en la base de datos y, opcionalmente, se pueden crear también otras tablas como <b>Roles</b> y <b>UserRoles</b>, si se quiere agregar distintos tipos de permisos a los usuarios (autorización).                    
                </p>   
                <p>
                    Como la finalidad de esta guía es abordar el uso de tokens JWT, nos limitaremos a trabajar simplemente con la tabla de usuarios.
                </p>            
                
                <h2>Script T-SQL para la creación de las tablas</h2>                
                <code>                                       
                    <span class="code-main-keyword">CREATE TABLE</span> [dbo].[<span class="code-highlight">Users</span>] (
                    &nbsp;&nbsp;[Id]           INT             IDENTITY (1, 1) NOT NULL,
                    &nbsp;&nbsp;[Username]     NVARCHAR (255)  NOT NULL,
                    &nbsp;&nbsp;[PasswordHash] NVARCHAR (255)  NOT NULL,
                    &nbsp;&nbsp;[PasswordSalt] VARBINARY (MAX) NOT NULL,
                    &nbsp;&nbsp;[Status]       BIT             NULL,
                    &nbsp;&nbsp;[FechaAlta]    DATETIME        NOT NULL,
                    &nbsp;&nbsp;[TipoUsuario]    int        NOT NULL,
                    &nbsp;&nbsp;PRIMARY KEY CLUSTERED ([Id] ASC),
                    &nbsp;&nbsp;UNIQUE NONCLUSTERED ([Username] ASC)
                    );   
                </code>
                <p>
                    Usamos los campos <b>PasswordHash</b> y <b>PasswordSalt</b> para guardar la contraseña encriptada y no exponer esta información en la tabla de usuarios de forma directa.
                </p>        
            </article>
        </section>
        <section class="main-section" id="scaffold">
            <header>Traer cambios de la DB al proyecto</header>
            <article>  
                <ol>
                    <li>
                        Abrir la Consola de Administración de Paquetes.
                    </li>
                    <li>
                        <p>
                            Correr el comando <b>Scaffold-DbContext</b> de actualización, para traer las nuevas tablas de la base de datos. Al tratarse de una actualización, es importante recordar incluir el parámetro <i>-Force</i>, para permitir la sobrescritura del DbContext.
                        </p>
                        <p>
                            Ejemplo:
                        </p>
                        <code>
                            <span class="code-main-keyword">Scaffold-DbContext</span> "Name=DefaultConnection" Microsoft.EntityFrameworkCore.SqlServer <span class="code-highlight">-Force</span> -OutputDir Models
                        </code>
                        <div class="notas">
                            NOTAS:
                            <ul>
                                <li>
                                    Se asume que se está trabajando sobre un proyecto ASP.NET Core existente, que usa EntityFrameworkCore. Si el proyecto se creó desde cero para probar el sistema de autenticación, ver el apartado de <a href="./guia-web-api.html#instalar_paquetes">instalación de paquetes NuGet</a> de la Guía ASP.NET Core Web API, para agregar los paquetes que serán requeridos previamente a la ejecución del comando anterior. 
                                </li>
                                <li>
                                    Este comando es válido sólo si se está usando la configuración por defecto de scaffolding.
                                </li>
                                <li>
                                    Si se está trabajando con Scaffolding personalizado, ver las opciones de scaffolding en la <a href="./guia-web-api.html#opciones_scaffold">Guía ASP.NET Core Web API</a>.
                                </li>
                            </ul>
                            
                        </div>
                    </li>                   
                </ol>                  
            </article>
        </section>
        <section class="main-section" id="code_first">
            <header>Opción Code First</header>
            <article>
                <h2>En caso de estar trabajando en un proyecto Code First:</h2> 
                <ol>
                    <li>
                        Crear las clases de entidad de modo que coincidan con lo propuesto para la tabla <b>Users</b> descripta en el apartado <a href="#crear_tablas">DB First</a> y, en caso de querer agregar diferentes tipos de permiso, crear también las clases de entidad para establecer las tablas necesarias para definir los roles.
                    </li>
                    <li>
                        Abrir la Consola de Administración de Paquetes.
                    </li>
                    <li>
                        <p>
                            Correr el comando de agregar migraciones para actualizar la base de datos a partir del código.
                        </p>
                        <p>
                            Ejemplo:
                        </p>
                        <code>
                            <span class="code-highlight">Add-Migration</span> nombreDeLaMigracion
                        </code>                                               
                    </li>        
                    <li>
                        <p>
                            Correr el comando para actualizar la base de datos a partir de las migraciones generadas.
                        </p>
                        <p>
                            Ejemplo:
                        </p>
                        <code>
                            <span class="code-highlight">Update-Database</span>
                        </code>  
                        <p>
                            Luego de esto, se debería poder visualizar las tablas creadas en la base de datos.
                        </p>
                    </li>           
                </ol>          
            </article>
        </section>
        <section class="main-section" id="instalar_paquetes">
            <header>Instalar paquetes</header>
            <article>
                <p>Para poder utilizar el sistema de autenticación con JWT, es necesario instalar el paquete  “Microsoft.AspNetCore.Authentication.JwtBearer”</p> 
                <ol>
                    <li>
                        Abrir Administrador de paquetes NuGet.
                    </li>
                    <li>
                        Buscar e instalar el paquete <b>Microsoft.AspNetCore.Authentication.JwtBearer</b>.
                    </li>
                    <div class="notas">
                        NOTA:
                        <p>
                            Es importante que la versión del paquete coincida con la versión de .Net del proyecto.                       
                            Si la API utiliza la versión .Net 8, se debe elegir una versión 8.x.x de este paquete (ej., 8.0.2).
                        </p>
                    </div>
                </ol>          
            </article>
        </section>

        <section class="main-section" id="configuracion">
            <header>Configuracion para usar el paquete JWT Bearer</header>
            <article>
                <p>Para poder utilizar el sistema de autenticación JWT, es necesario definir algunos atributos de configuracion en appsettings.json y agregar el servicio al contenedor de servicios en Program.cs</p> 
                <h2>En appsettings.json</h2>
                <ul>
                    <li>
                        En el archivo de configuración <b>appsettings.json</b>, se agregarán los siguientes atributos:
                        <ul>
                            <li>
                                <b>Key</b>: Es una clave que servirá para generar y validar el token de acceso. 
                                <p>
                                    Se puede usar una página como <a href="https://www.random.org/strings/">random.org</a> para generar esta clave, seleccionando las opciones para incluir valores numéricos, mayúsculas y minúsculas.
                                </p>
                            </li>
                            <li>
                                <b>Issuer</b> y <b>Audience</b>: Sirven para validar la plataforma desde la cual se se efectúa la solicitud. (No obligatorio)
                            </li>
                            <li>
                                <b>TokenExpirationMinutes</b>: Indica el tiempo de expiración que se quiera determinar para el token de acceso.
                            </li>
                        </ul>                     
                    </li>
                    <li>
                        <p>
                            Ejemplo: 
                            <code>
                                "JwtSettings": {
                                    &nbsp;&nbsp;"Key": "wOajndfmty1dwuQOak68N2NadtM8HW5M",
                                    &nbsp;&nbsp;"Issuer": "https://localhost:80/",
                                    &nbsp;&nbsp;"Audience": "https://localhost:80/",
                                    &nbsp;&nbsp;"TokenExpirationMinutes": 60
                                  }
                            </code>
                        </p>
                    </li>                    
                </ul>    
                <h2>En Program.cs</h2>
                <ul>
                    <li>
                        En el archivo <b>Program.cs</b>, se agrega el servicio JwtBearer al contenedor de servicios:
                        <code>
                            var builder = WebApplication.CreateBuilder(args);

                            <span class="code-comment">//Auth - JWT Token</span>
                            <span class="code-highlight">
                            var config = builder.Configuration;

                            builder.Services.AddAuthentication(x =>
                            {
                                &nbsp;&nbsp;x.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
                                &nbsp;&nbsp;x.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
                                &nbsp;&nbsp;x.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
                            }).AddJwtBearer(x =>
                            {
                                &nbsp;&nbsp;x.TokenValidationParameters = new TokenValidationParameters
                                &nbsp;&nbsp;{
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidIssuer = config["JwtSettings:Issuer"],
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidAudience = config["JwtSettings:Audience"],
                                &nbsp;&nbsp;&nbsp;&nbsp;IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(config["JwtSettings:Key"]))
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidateAudience = true, 
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidateIssuer = true, 
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidateLifetime = true,
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidateIssuerSigningKey = true
                                &nbsp;&nbsp;};
                            });

                            builder.Services.AddAuthorization();
                            
                            <span class="code-comment">// Otros servicios</span>                                
                            </span>
                            var app = builder.Build();
                        </code>
                    </li>  
                    <li>
                        Si se quiere realizar pruebas desde Swagger UI, se debe configurar Swagger para que utilice autenticación JWT Bearer:
                    </li>   
                    <code>
                        var builder = WebApplication.CreateBuilder(args);

                        <span class="code-comment">//Auth - JWT Token</span>

                            var config = builder.Configuration;

                            builder.Services.AddAuthentication(x =>
                            {
                                &nbsp;&nbsp;x.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
                                &nbsp;&nbsp;x.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
                                &nbsp;&nbsp;x.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
                            }).AddJwtBearer(x =>
                            {
                                &nbsp;&nbsp;x.TokenValidationParameters = new TokenValidationParameters
                                &nbsp;&nbsp;{
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidIssuer = config["JwtSettings:Issuer"],
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidAudience = config["JwtSettings:Audience"],
                                &nbsp;&nbsp;&nbsp;&nbsp;IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(config["JwtSettings:Key"])),       
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidateAudience = true, <span class="code-comment">// Dejar en false si no se queire validar</span>
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidateIssuer = true, <span class="code-comment">// Dejar en false si no se queire validar</span>
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidateLifetime = true,
                                &nbsp;&nbsp;&nbsp;&nbsp;ValidateIssuerSigningKey = true
                                &nbsp;&nbsp;};
                            });

                            builder.Services.AddAuthorization();

                            <span class="code-highlight">
                            builder.Services.AddSwaggerGen(c =>
                            {
                            &nbsp;&nbsp;c.SwaggerDoc("v1", new OpenApiInfo { Title = "AuthTest", Version = "v1" });
                            &nbsp;&nbsp;// Configura la seguridad de Swagger para requerir un token JWT
                            &nbsp;&nbsp;c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
                            &nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;In = ParameterLocation.Header,
                            &nbsp;&nbsp;&nbsp;&nbsp;Description = "Por favor, introduce el token JWT en este formato: Bearer <i>tu.token.de.acceso</i>, separando la palabra \"Bearer\" del token por un espacio.",
                            &nbsp;&nbsp;&nbsp;&nbsp;Name = "Authorization",
                            &nbsp;&nbsp;&nbsp;&nbsp;Type = SecuritySchemeType.ApiKey
                            &nbsp;&nbsp;});
                            &nbsp;&nbsp;c.AddSecurityRequirement(new OpenApiSecurityRequirement
                            &nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new OpenApiSecurityScheme
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reference = new OpenApiReference { Type = ReferenceType.SecurityScheme, Id = "Bearer" }
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Array.Empty<<span>string</span>>()
                            &nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;});
                            });
                            </span>
                            
                            <span class="code_comment">// Otros servicios</span>                                
                        
                        var app = builder.Build();
                    </code>   
                </ul>            
            </article>
        </section>

        <section class="main-section" id="registrar_usuarios">
            <header>Registrar usuarios</header>
            <article>
                <p>
                    Como se menciona en el apartado donde se crea de la tabla de usuarios, la contraseña la guardaremos encriptada en la base de datos, con el objetivo de proteger esta información.
                </p>
                <p>
                    Por este motivo, será necesario crear una clase auxiliar con métodos para encriptar y validar la contraseña. 
                </p>
                <p>
                    A continuación se detallan los pasos a seguir para administrar el manejo de contraseñas al registrar y validar un usuario.
                </p>
                <ol>
                    <li>
                        Si no existe, crear el directorio auxiliar en la raíz del proyecto. Ej., "Helpers".
                    </li>
                    <li>
                        Dentro de este directorio auxiliar, crear la clase <i>PasswordHasher</i>.
                    </li>
                    <li>
                        Esta clase tendrá dos métodos estáticos: 
                        <li>
                            <b>HashPassword</b>, que recibe la contraseña ingresada por el usuario al registrarse y devuelve la contraseña encriptada y un valor de tipo byte[] que sirve como llave para luego desencriptar la contraseña guardada a la hora de validar el proceso de login.
                        </li>
                        <li>
                            <b>VerifyPassword</b>, que recibe la contraseña ingresada por el usuario y los valores <i>PasswordHash</i> y <i>PasswordSalt</i> guardados en la tabla de usuarios, para el nombre de usuario ingresado.
                        </li>
                    </li>
                    <li>
                        Así se verá nuestra clase que administra el registro y validación de contraseñas:
                        <code>
                            using System.Security.Cryptography;
                            using System.Text;

                            namespace JwtTokenTest2.Helper
                            {
                                &nbsp;&nbsp;public class PasswordHasher
                                &nbsp;&nbsp;{
                                <span class="code-main-keyword">&nbsp;&nbsp;&nbsp;&nbsp;public static (string hashedPassword, byte[] salt) HashPassword(string password)</span>
                                &nbsp;&nbsp;&nbsp;&nbsp;{
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;using (var sha256 = SHA256.Create())
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[] salt = new byte[16];
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;using (var rng = RandomNumberGenerator.Create())
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rng.GetBytes(salt);
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}

                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[] passwordBytes = Encoding.UTF8.GetBytes(password);
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[] saltedPassword = new byte[passwordBytes.Length + salt.Length];

                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Buffer.BlockCopy(passwordBytes, 0, saltedPassword, 0, passwordBytes.Length);
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Buffer.BlockCopy(salt, 0, saltedPassword, passwordBytes.Length, salt.Length);

                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[] hashedPassword = sha256.ComputeHash(saltedPassword);

                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (Convert.ToBase64String(hashedPassword), salt);
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
                                &nbsp;&nbsp;&nbsp;&nbsp;}

                                <span class="code-main-keyword">&nbsp;&nbsp;&nbsp;&nbsp;public static bool VerifyPassword(string hashedPassword, byte[] salt, string passwordToCheck)</span>
                                &nbsp;&nbsp;&nbsp;&nbsp;{
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;using (var sha256 = SHA256.Create())
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[] passwordBytes = Encoding.UTF8.GetBytes(passwordToCheck);
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[] saltedPassword = new byte[passwordBytes.Length + salt.Length];

                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Buffer.BlockCopy(passwordBytes, 0, saltedPassword, 0, passwordBytes.Length);
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Buffer.BlockCopy(salt, 0, saltedPassword, passwordBytes.Length, salt.Length);

                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte[] hashedPasswordToCheck = sha256.ComputeHash(saltedPassword);
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string hashedPasswordToCheckBase64 = Convert.ToBase64String(hashedPasswordToCheck);

                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return hashedPassword == hashedPasswordToCheckBase64;
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
                                &nbsp;&nbsp;&nbsp;&nbsp;}
                                &nbsp;&nbsp;}
                            }
                        </code>
                    </li>
                    <li>
                        Llamado a estos métodos desde el controlador de usuarios:
                        <code>
                            using JwtTokenTest2.Data;
                            using JwtTokenTest2.DTOs;
                            using JwtTokenTest2.Helper;
                            using JwtTokenTest2.Models;
                            using Microsoft.AspNetCore.Mvc;

                            namespace JwtTokenTest2.Controllers
                            {
                            &nbsp;&nbsp;[Route("api/[controller]")]
                            &nbsp;&nbsp;[ApiController]
                            &nbsp;&nbsp;public class AuthController : ControllerBase
                            &nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;private readonly IConfiguration _config;
                            &nbsp;&nbsp;&nbsp;&nbsp;private readonly AppDbContext _appDbContext;

                            &nbsp;&nbsp;&nbsp;&nbsp;public AuthController(IConfiguration config, AppDbContext appDbContext)
                            &nbsp;&nbsp;&nbsp;&nbsp;{  
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_config = config;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_appDbContext = appDbContext;   
                            &nbsp;&nbsp;&nbsp;&nbsp;}


                            &nbsp;&nbsp;&nbsp;&nbsp;[HttpPost("register")]
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Se utiliza un DTO de usuario que tiene como atributos UserName y Password</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;public async Task<IActionResult> Register([FromBody] UserDto newUser)
                            &nbsp;&nbsp;&nbsp;&nbsp;{

                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-highlight">var (hashedPassword, passwordSalt) = PasswordHasher.HashPassword(newUser.Password);
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var user = new User { 
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserName = newUser.UserName,
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PasswordHash = hashedPassword,
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PasswordSalt = passwordSalt
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;await _appDbContext.AddAsync(user);
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var usuarioCreado = _appDbContext.SaveChangesAsync().Result;

                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (usuarioCreado >= 0)
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return CreatedAtAction("Register", user.Id, user);
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return BadRequest();
                            &nbsp;&nbsp;&nbsp;&nbsp;}

                            &nbsp;&nbsp;&nbsp;&nbsp;
                            &nbsp;&nbsp;&nbsp;&nbsp;[HttpPost("login")]
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Se utiliza un DTO de usuario que tiene como atributos UserName y Password</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;public IActionResult Login([FromBody] UserDto loginUser)
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool validPass = false;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var user = _appDbContext.Users.FirstOrDefault(u => u.UserName.Equals(loginUser.UserName));
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (user != null)
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-highlight">validPass = PasswordHasher.VerifyPassword(user.PasswordHash, user.PasswordSalt, loginUser.Password);</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (user == null || !validPass)
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return Unauthorized("Credenciales inválidas");
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// El manejo del token JWT se verá en el siguiente apartado.</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var token = JwtTokenManager.GenerateJwtToken(user, _config);
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return Ok(new { Token = token });
                            &nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;}
                            }
                        </code>
                    </li>
                </ol>

            </article>
        </section>


        <section class="main-section" id="clase_jwt_admin">
            <header>Emitir y valdar tokens</header>
            <article>
                <p>Se crea una nueva clase con la finalidad de administrar la emisión y validación de tokens. Esta clase se va a ubicar en un directorio destinado a clases auxiliares, de utilidad para diferentes servicios y funcionalidades de la API.</p> 
                <ol>                   
                    <li>
                        Dentro del directorio auxiliar creado en el punto anterior, crear la clase estática <b>JwtTokenManager.cs</b>
                    </li>
                    <li>
                        En esta clase de van a definir dos métodos estáticos:
                        <ul>
                            <li>
                                Uno para generar el token, que recibe dos parámetros: las credenciales del usuario y una instancia de la interfaz <i>IConfiguration</i> para obtener la Key que registramos en appsettings.json
                            </li>
                            <li>
                                Otro para validar el token, que recibe los siguientes parámetros: el token a validar y una instancia de la interfaz <i>IConfiguration</i> para obtener la Key que registramos en appsettings.json
                            </li>
                        </ul>
                    </li>
                    <li>
                        <b>JwtTokenManager.cs</b>
                        <code>
                            public static class <span class="code-main-keyword">JwtTokenManager</span>
                            {                
                            &nbsp;&nbsp;public static string <span class="code-highlight">GenerateJwtToken</span>(User user, IConfiguration configuration)
                            &nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;var securityKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(configuration["JwtSettings:Key"]));
                            &nbsp;&nbsp;&nbsp;&nbsp;var credentials = new SigningCredentials(securityKey, SecurityAlgorithms.HmacSha256);                    
                            &nbsp;&nbsp;&nbsp;&nbsp;var claims = new[]
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;new Claim(JwtRegisteredClaimNames.Sub, user.UserName)                
                            &nbsp;&nbsp;&nbsp;&nbsp;};                    
                            &nbsp;&nbsp;&nbsp;&nbsp;int TokenExpiration = Convert.ToInt32(configuration["JwtSettings:TokenExpirationMinutes"]);                    
                            &nbsp;&nbsp;&nbsp;&nbsp;var token = new JwtSecurityToken(
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;issuer: configuration["JwtSettings:Issuer"],
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;audience: configuration["JwtSettings:Audience"],
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;claims: claims,
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;expires: DateTime.UtcNow.AddMinutes(TokenExpiration),
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;signingCredentials: credentials
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);
                    
                            &nbsp;&nbsp;&nbsp;&nbsp;return new JwtSecurityTokenHandler().WriteToken(token);
                            &nbsp;&nbsp;}

                            &nbsp;&nbsp;public static bool <span class="code-highlight">ValidateToken</span>(string token, IConfiguration configuration)
                            &nbsp;&nbsp;{ 
                            &nbsp;&nbsp;&nbsp;&nbsp;if (!string.IsNullOrEmpty(token))
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try 
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ 
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var securityKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(configuration["JwtSettings:Key"]));
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var tokenHandler = new JwtSecurityTokenHandler();
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Verificar validez del token.</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tokenHandler.ValidateToken(token, new TokenValidationParameters
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidateIssuer = true, 
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidateAudience = true,
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidIssuer = configuration["JwtSettings:Issuer"],
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidAudience = configuration["JwtSettings:Audience"],
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IssuerSigningKey = securityKey,
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ValidateLifetime = false <span class="code-comment">// Mientras no haya registro de logs, la fecha de expiración se valida por separado para un mejor seguimiento.</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, out SecurityToken validatedToken);
        
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Verificar la fecha de expiración</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (validatedToken is JwtSecurityToken jwtToken && jwtToken.ValidTo > DateTime.Now)
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch (Exception)
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;return false;
                            &nbsp;&nbsp;}                    
                            }    
                        </code>
                    </li>
                    <li>
                        Llamado a los métodos desde el controlador:
                        <code>
                            [Route("api/[controller]")]
                            [ApiController]
                            public class <span class="code-main-keyword">AuthController</span> : ControllerBase
                            {
                            &nbsp;&nbsp;private readonly IConfiguration _config;
                            &nbsp;&nbsp;private readonly AppDbContext _appDbContext;&nbsp;&nbsp;&nbsp;&nbsp;

                            &nbsp;&nbsp;public <span class="code-main-keyword">AuthController</span>(IConfiguration config, AppDbContext appDbContext)
                            &nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;   
                            &nbsp;&nbsp;&nbsp;&nbsp;_config = config;
                            &nbsp;&nbsp;&nbsp;&nbsp;_appDbContext = appDbContext;&nbsp;&nbsp;&nbsp;&nbsp;   
                            &nbsp;&nbsp;}
                           
                            &nbsp;&nbsp;[HttpPost("login")]
                            &nbsp;&nbsp;&nbsp;&nbsp;<span class="code-comment">// Se utiliza un DTO de usuario que tiene como atributos UserName y Password</span>
                            &nbsp;&nbsp;public IActionResult <span class="code-highlight">Login</span>([FromBody] UserDto loginUser)
                            &nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;bool validPass = false;
                            &nbsp;&nbsp;&nbsp;&nbsp;var user = _appDbContext.Users.FirstOrDefault(u => u.UserName.Equals(loginUser.UserName));
                            &nbsp;&nbsp;&nbsp;&nbsp;if (user != null)
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validPass = PasswordHasher.VerifyPassword(user.PasswordHash, user.PasswordSalt, loginUser.Password);
                            &nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;if (user == null || !validPass)
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return Unauthorized("Credenciales inválidas");
                            &nbsp;&nbsp;&nbsp;&nbsp;}                            
                            &nbsp;&nbsp;&nbsp;&nbsp;var token = <span class="code-parametro">JwtTokenManager.GenerateJwtToken</span>(user, _config);
                            &nbsp;&nbsp;&nbsp;&nbsp;return Ok(new { Token = token });
                            &nbsp;&nbsp;}


                            &nbsp;&nbsp;[HttpPost("validate-token")]
                            &nbsp;&nbsp;public IActionResult <span class="code-highlight">ValidateToken</span>([FromHeader]string token)
                            &nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;bool tokenValido = <span class="code-parametro">JwtTokenManager.ValidateToken</span>(token, _config);
                            &nbsp;&nbsp;&nbsp;&nbsp;if (!tokenValido)
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return Unauthorized("Token inválido. Inicie sesión para generar un nuevo token de acceso.");
                            &nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;return Ok("Token válido.");
                            &nbsp;&nbsp;}
                            }
                        </code>
                    </li>
                </ol>          
            </article>
        </section>
        <section class="main-section" id="probar">
            <header>Probar el sistema de autenticación JWT</header>
            <article>
                <ul>                    
                    <li>
                        Probar con Swagger.
                    </li>   
                    <li>
                        Probar con Postman.
                    </li>                                 
                </ul>
                <h2>Probar autenticación con Swagger</h2>
                <ol>
                    <li>
                        <p>
                            Ir al botón Authenticate.
                        </p>
                        <img class="project-cap" src="../images/jwt-swagger-auth.png" alt="">
                        
                    </li>
                    <li>
                        <p>
                            Luego completar el cuadro con la palabra <i>"Bearer"</i> seguida de un espacio y luego copiar el token obtenido como respuesta al hacer una solicitud al endpoint de login.
                        </p>
                        <img class="project-cap" src="../images/jwt-swagger-bearer.png" alt="">                       
                       
                    </li>
                    <li>
                        <p>
                            Una vez realizado el paso anterior, será posible acceder a los recursos que se encuentren protegidos con el decorador <b>[Authorize]</b>
                        </p>
                        <p>El decorador <b>[Authorize]</b> puede ser aplicado a un controlador en general, agregándolo sobre la definición del mismo, o bien sobre un endpoint del controlador específicamente. En el segundo caso, el decorador <b>[Authorize]</b> se coloca encima de la definición del endpoint que se quiera proteger. 

                        </p>
                    </li>
                </ol>
                <h2>Probar autenticación con Postman</h2>
                <ol>
                    <li>
                        Desde Postman, realizar una solicitud al endpoint de login para obtener el token de acceso.
                    </li>
                    <li>
                        Abrir otra solicitud para consumir alguno de los endpoints que se encuentren protegidos y completar todos los datos requeridos para la solicitud (url, parámetros, etc). 
                    </li>
                    <li>
                        Antes de ejecutar la solicitud, ir a <i>Headers</i>, crear la Key <i>Authorization</i> y, como valor, asignar la misma leyenda que se describe para completar el recuadro de la interfaz de Swagger: <b>Bearer</b> <i>mi.token.de.acceso</i> 
                    </li>
                    <img class="project-cap" src="../images/jwt-postman-test.png" alt="">
                </ol>
                <div class="notas">
                    NOTAS:
                    <li>
                        En caso de que no se realice el paso de autenticación para consumir un endpoint protegido, éste devolverá una respuesta 401 (Unauthorized) y en el header de la respuesta, se recibirá la key <i>WWW-Authenticate</i> con el valor <b>Bearer</b>.
                    </li>
                    <li>
                        Si se intenta enviar un token inválido, el valor de <i>WWW-Authenticate</i> podría tener información más específica acerca del error. Ej., token expirado.
                    </li>
                </div>  
                <!-- <div class="text-center">
                    <p style="font-size: 1.8rem; color: rgba(96, 173, 66);">En construcción...</p>
                    <iconify-icon  style="font-size: 100px; color: rgba(96, 173, 66);" icon="healthicons:plantation-worker-alt"></iconify-icon>
                </div> -->
            </article>
        </section>
        <section class="main-section" id="consumir">
            <header>Consumir una API con autenticación JWT</header>
            <article>          
                <p>
                    Consumo de una API con autenticación JWT desde una aplicación ASP.NET Core MVC.                    
                </p>
                <h2>Agregar servicios al contenedor:</h2> 
                <p>
                    En el archivo Program.cs, se agregan dos servicios: 
                    <ul>
                        <li>
                            El cliente http para consumir la API
                        </li>
                        <li>
                            La sesión para almacenar coockies
                        </li>
                    </ul>
                </p>          
                <code>
                    var builder = WebApplication.CreateBuilder(args);
                    
                    <span class="code-highlight">builder.Services.AddHttpClient("API", client =>
                    {
                    &nbsp;&nbsp;client.BaseAddress = new Uri("https://localhost:80");
                    &nbsp;&nbsp;client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));
                    });
                    builder.Services.AddSession(options =>
                    {
                    &nbsp;&nbsp;options.Cookie.HttpOnly = true;
                    &nbsp;&nbsp;options.Cookie.IsEssential = true;
                    &nbsp;&nbsp;options.Cookie.SameSite = SameSiteMode.None;
                    &nbsp;&nbsp;options.Cookie.SecurePolicy = CookieSecurePolicy.Always;
                    });</span>                     
                    <span class="code-comment">// Otros servicios...</span>
                    
                    var app = builder.Build();
                </code>
                <h2>Indicar que la aplicación va a hacer uso de variables de sesión, del contexto http, autenticación y autorización:</h2>                      
                <code>
                    var app = builder.Build();
                    <span class="code-highlight">
                    app.UseAuthentication();
                    app.UseAuthorization();

                    app.MapControllerRoute(
                    &nbsp;&nbsp;name: "default",
                    &nbsp;&nbsp;pattern: "{controller=Home}/{action=Index}/{id?}");

                    app.UseSession();
                    app.UseRouting();

                    app.UseEndpoints(endpoints =>
                    {
                    &nbsp;&nbsp;endpoints.MapControllerRoute(
                    &nbsp;&nbsp;&nbsp;&nbsp;name: "default",
                    &nbsp;&nbsp;&nbsp;&nbsp;pattern: "{controller=Home}/{action=Index}/{id?}");
                    });
                    </span>
                    app.Run();
                </code>
                <h2>Guardar y consultar información de sesión de un usuario:</h2>
                <ul>
                    <li>
                        <p>
                            Guardar información del usuario en las cookies de la sesión, al consumir el endpoint de login.
                        </p>                        
                        <code>
                            [HttpPost]
                            public async Task<<span>IActionResult</span>><span class="code-main-keyword">Login</span>(UserDto user)
                            {
                            &nbsp;&nbsp;var token = await _accountRepository.LoginAsync(user);
    
                            &nbsp;&nbsp;if (token == null)
                            &nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;TempData["Error"] = "Credenciales inválidas";
                            &nbsp;&nbsp;&nbsp;&nbsp;return RedirectToAction("Login");
                            &nbsp;&nbsp;}
                            &nbsp;&nbsp;
                            &nbsp;&nbsp;JsonDocument jsonDocument = JsonDocument.Parse(token);
    
                            &nbsp;&nbsp;var tokenValue = "";
                            &nbsp;&nbsp;if (jsonDocument.RootElement.TryGetProperty("token", out JsonElement tokenElement))
                            &nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;tokenValue = tokenElement.GetString();
                            &nbsp;&nbsp;}
    
                            &nbsp;&nbsp;if (!string.IsNullOrEmpty(tokenValue))
                            &nbsp;&nbsp;{
                            <span class="code-highlight">&nbsp;&nbsp;&nbsp;&nbsp;HttpContext.Session.SetString("UserName", user.UserName);
                            &nbsp;&nbsp;&nbsp;&nbsp;HttpContext.Session.SetString("Token", tokenValue);</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;return RedirectToAction("Index", "Home");
                            &nbsp;&nbsp;}
                            &nbsp;&nbsp;else
                            &nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;TempData["Error"] = "Credenciales inválidas";
                            &nbsp;&nbsp;&nbsp;&nbsp;return RedirectToAction("Login");
                            &nbsp;&nbsp;}
                            }
                        </code>
                    </li>
                    <li>
                        <p>
                            Consultar información guardadda en las cookies de la sesión, para validar el usuario al consumir los endpoints protegidos.
                        </p>                        
                        <code>                            
                            [HttpPost]
                            public async Task<<span>IActionResult</span>> <span class="code-main-keyword">RealizarPedido</span>(List<<span>DetallePedidoDto</span>> pedidoItems)
                            {
                            &nbsp;&nbsp;var itemsSeleccionados = pedidoItems
                            &nbsp;&nbsp;&nbsp;&nbsp;.Where(item => !string.IsNullOrEmpty(item.Empanada) && item.Cantidad >= 1)
                            &nbsp;&nbsp;&nbsp;&nbsp;.ToList();
                            &nbsp;&nbsp;if (itemsSeleccionados.Count > 0)
                            &nbsp;&nbsp;{

                            <span class="code-comment">&nbsp;&nbsp;&nbsp;&nbsp;//Consultar los valores de las variables de sesión "UserName" y "Token" que creé en el login.</span> 
                            <span class="code-highlight">&nbsp;&nbsp;&nbsp;&nbsp;var userName = HttpContext.Session.GetString("UserName");
                            &nbsp;&nbsp;&nbsp;&nbsp;var token = HttpContext.Session.GetString("Token");</span>
                            &nbsp;&nbsp;&nbsp;&nbsp;var pedidoDto = new PedidoDto
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NombreUsuario = userName,
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pedido = itemsSeleccionados
                            &nbsp;&nbsp;&nbsp;&nbsp;};

                            &nbsp;&nbsp;&nbsp;&nbsp;var respuestaPedido = await _pedidoRepository.RealizarPedido(userName, pedidoDto, token);

                            &nbsp;&nbsp;&nbsp;&nbsp;if (!string.IsNullOrEmpty(respuestaPedido))
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(respuestaPedido == "Ok")
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return RedirectToAction("MostrarPedido", pedidoDto);
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (respuestaPedido == "400")
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ModelState.AddModelError(string.Empty, "Ya hiciste tu pedido el día de hoy.");
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}   
                            &nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;&nbsp;&nbsp;else
                            &nbsp;&nbsp;&nbsp;&nbsp;{
                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ModelState.AddModelError(string.Empty, "Error al realizar el pedido");
                            &nbsp;&nbsp;&nbsp;&nbsp;}
                            &nbsp;&nbsp;}
                            &nbsp;&nbsp;return View("../Home/Index");
                            }
                        </code>
                    </li>
                    
                </ul>
            </article>
        </section>
        <hr>
        <footer>
            <div class="sign-div">
                <p class="titulo-sign">
                    Daniela Pinto                
                </p>
                <img id="img-titulo" src="../images/cassette.png"/>
                <p class="titulo-sign-sub">
                    Software Developer
                </p>
            </div>       
        </footer>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
